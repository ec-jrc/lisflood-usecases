
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Following steps &#8212; A LISFLOOD catchment model - the Nam Ngum River</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Main run" href="3_run.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/header.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">A LISFLOOD catchment model - the Nam Ngum River</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="0_general_setup.html">
   Input and general settings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="1_initialization.html">
   Initialization run
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="2_warmup.html">
   Warmup run
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="3_run.html">
   Main run
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Following steps
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/4_following_steps.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#settings">
   1 Settings
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#initialization">
   2 Initialization
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#warmup">
   3 Warmup
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#end-maps">
     3.1 End maps
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#lower-groundwater-zone">
     3.2 Lower groundwater zone
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#run">
   4 Run
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Following steps</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#settings">
   1 Settings
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#initialization">
   2 Initialization
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#warmup">
   3 Warmup
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#end-maps">
     3.1 End maps
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#lower-groundwater-zone">
     3.2 Lower groundwater zone
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#run">
   4 Run
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <p><img alt="header" src="_images/header.png" /></p>
<section class="tex2jax_ignore mathjax_ignore" id="following-steps">
<h1>Following steps<a class="headerlink" href="#following-steps" title="Permalink to this headline">#</a></h1>
<br>
<br>
<br>
<p>So far we have developed a LISFLOOD model than runs and it is correctly initialized. However, we are using default model parameters, so there’s no confidence at all in the accuracy of the model. Before you can extract any conclusions from your model results, the model needs to be calibrated. As a result of the calibration, the model parameters are tuned so that the outputs reproduce observed data as good as possible. Calibration is usually performed on the river discharge timeseries at one or more gauging stations, but there are plenty of other calibration procedures.</p>
<p>To perform a calibration, LISFLOOD proposes a <a class="reference external" href="https://github.com/ec-jrc/lisflood-calibration">calibration tool</a> based on DEAP (Distributed Evolutionary Algorithms in Python) (Fortin et al., 2012).The calibration procedure exceeds the scope of this tutorial, so we will not get into it. Please, feel free to use any other calibration procedure and optimization algorithm.</p>
<section id="settings">
<h2>1 Settings<a class="headerlink" href="#settings" title="Permalink to this headline">#</a></h2>
<p>The repository includes three settings files (one for each of the runs) in which we have changed the calibration parameters according to the results of the calibration of the model (<code class="docutils literal notranslate"><span class="pre">lfuser</span></code> element in the settings file). Apart from the calibration parameters, we have changed the output directories, so the results don’t overwrite those of the previous runs. The results will be saved in subdirectories called <em>calibrated</em>; for instance, the initial conditions will be saved in the folder <em>initial/calibrated</em> instead of the folder <em>initial</em>.</p>
<p>The snippet below shows a part of the file <em>settins_calibrated_run.xml</em> that defines the paths to the initial conditions and where results will be saved, and the definition of the calibration parameters.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;lfuser&gt;</span>
    
    [...]
    
    <span class="cm">&lt;!--</span>
<span class="cm">    **************************************************************</span>
<span class="cm">    FILE PATHS</span>
<span class="cm">    **************************************************************</span>
<span class="cm">    --&gt;</span>
    <span class="nt">&lt;textvar</span> <span class="na">name=</span><span class="s">&quot;PathOut&quot;</span> <span class="na">value=</span><span class="s">&quot;$(PathRoot)/out/run/calibrated&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;textvar</span> <span class="na">name=</span><span class="s">&quot;PathInit&quot;</span> <span class="na">value=</span><span class="s">&quot;$(PathRoot)/initial/calibrated&quot;</span><span class="nt">/&gt;</span>
            
    <span class="cm">&lt;!--</span>
<span class="cm">    **************************************************************</span>
<span class="cm">    CALIBRATION PARAMETERS</span>
<span class="cm">    **************************************************************</span>
<span class="cm">    --&gt;</span>
    <span class="nt">&lt;textvar</span> <span class="na">name=</span><span class="s">&quot;UpperZoneTimeConstant&quot;</span> <span class="na">value=</span><span class="s">&quot;7.47476&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;textvar</span> <span class="na">name=</span><span class="s">&quot;LowerZoneTimeConstant&quot;</span> <span class="na">value=</span><span class="s">&quot;153.604&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;textvar</span> <span class="na">name=</span><span class="s">&quot;GwPercValue&quot;</span> <span class="na">value=</span><span class="s">&quot;1.643&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;textvar</span> <span class="na">name=</span><span class="s">&quot;GwLoss&quot;</span> <span class="na">value=</span><span class="s">&quot;0.501192&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;textvar</span> <span class="na">name=</span><span class="s">&quot;LZThreshold&quot;</span> <span class="na">value=</span><span class="s">&quot;16.1032&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;textvar</span> <span class="na">name=</span><span class="s">&quot;b_Xinanjiang&quot;</span> <span class="na">value=</span><span class="s">&quot;0.215152&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;textvar</span> <span class="na">name=</span><span class="s">&quot;PowerPrefFlow&quot;</span> <span class="na">value=</span><span class="s">&quot;2.51033&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;textvar</span> <span class="na">name=</span><span class="s">&quot;CalChanMan&quot;</span> <span class="na">value=</span><span class="s">&quot;1.8149&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;textvar</span> <span class="na">name=</span><span class="s">&quot;CalChanMan2&quot;</span> <span class="na">value=</span><span class="s">&quot;5&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;textvar</span> <span class="na">name=</span><span class="s">&quot;SnowMeltCoef&quot;</span> <span class="na">value=</span><span class="s">&quot;2.55434&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;textvar</span> <span class="na">name=</span><span class="s">&quot;LakeMultiplier&quot;</span> <span class="na">value=</span><span class="s">&quot;0.875565&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;textvar</span> <span class="na">name=</span><span class="s">&quot;adjust_Normal_Flood&quot;</span> <span class="na">value=</span><span class="s">&quot;0.49691&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;textvar</span> <span class="na">name=</span><span class="s">&quot;ReservoirRnormqMult&quot;</span> <span class="na">value=</span><span class="s">&quot;1.30807&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;textvar</span> <span class="na">name=</span><span class="s">&quot;AvWaterRateThreshold&quot;</span> <span class="na">value=</span><span class="s">&quot;5.0&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;textvar</span> <span class="na">name=</span><span class="s">&quot;QSplitMult&quot;</span> <span class="na">value=</span><span class="s">&quot;1.99051&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;textvar</span> <span class="na">name=</span><span class="s">&quot;ChanBottomWMult&quot;</span> <span class="na">value=</span><span class="s">&quot;1.0&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;textvar</span> <span class="na">name=</span><span class="s">&quot;ChanDepthTMult&quot;</span> <span class="na">value=</span><span class="s">&quot;1.0&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;textvar</span> <span class="na">name=</span><span class="s">&quot;ChanSMult&quot;</span> <span class="na">value=</span><span class="s">&quot;1.0&quot;</span><span class="nt">/&gt;</span>
        
    [...]
    
<span class="nt">&lt;/lfuser&gt;</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">lisflood_read_plot</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">path_model</span> <span class="o">=</span> <span class="s1">&#39;../../model/&#39;</span>
<span class="n">path_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_model</span><span class="si">}</span><span class="s1">out/run/&#39;</span>
</pre></div>
</div>
</section>
<section id="initialization">
<h2>2 Initialization<a class="headerlink" href="#initialization" title="Permalink to this headline">#</a></h2>
<p>As explained in <a class="reference external" href="#1_initialization.ipynb">Chapter 2 - Initialization</a>, this run is meant to create two outmaps that define the average river discharge (<em><a class="reference external" href="http://avgdis.nc">avgdis.nc</a></em>) and the average inflow into the lower groundwater zone (<em><a class="reference external" href="http://lzavin.nc">lzavin.nc</a></em>). Let’s see how these initialization maps change once we apply the calibration parameters.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">cmap</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;lzavin&#39;</span><span class="p">,</span> <span class="s1">&#39;avgdis&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="s1">&#39;Greens&#39;</span><span class="p">])):</span>
    <span class="n">non_calib</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_model</span><span class="si">}</span><span class="s1">/initial/</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">.nc&#39;</span><span class="p">)</span>
    <span class="n">non_calib</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">calib</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_model</span><span class="si">}</span><span class="s1">/initial/calibrated/</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">.nc&#39;</span><span class="p">)</span>
    <span class="n">calib</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="n">vmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">non_calib</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">calib</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">non_calib</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">calib</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    
    <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">non_calib</span><span class="p">,</span> <span class="n">calib</span><span class="p">]):</span>
        <span class="n">da</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">.275</span><span class="p">,</span> <span class="mf">.9</span><span class="p">,</span> <span class="s1">&#39;Uncalibrated&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">.7</span><span class="p">,</span> <span class="mf">.9</span><span class="p">,</span> <span class="s1">&#39;Calibrated&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p><img alt="png" src="_images/4_1.png" /></p>
<p><em><strong>Figure 1</strong>. Output maps from the initialization run: average inflow into the lower groundwater zone (<em>LZAvin</em>) and average river discharge (<em>avgdis</em>). The left column corresponds to the initialization with default parameters, and the right column to the initialization with calibrated parameters.</em></p>
<p>In our study case, the change in the <em>lzavin</em> is notorious.</p>
</section>
<section id="warmup">
<h2>3 Warmup<a class="headerlink" href="#warmup" title="Permalink to this headline">#</a></h2>
<p>As explained in <a class="reference external" href="#2_warmup.ipynb">Chapter 3 - Warmup</a>, this objective of this run is to find the initial conditions at the begining of the target run. The usual output of these simulation is a set of maps (NetCDF) with the model state variables at the end of the simulation. For educational purposes, we chose to write, not only the end state maps, but also the map stack of one of the state variables: the lower groundwater zone.</p>
<p>Let’s see how some of the outputs of this run has changed with the calibrated parameters and the new initialization maps.</p>
<section id="end-maps">
<h3>3.1 End maps<a class="headerlink" href="#end-maps" title="Permalink to this headline">#</a></h3>
<p>The following figure compares the end state maps of the warmup run with default parameters (<em>uncalibrated</em>) and the run with calibrated parameters (<em>calibrated</em>). Only five state variables are shown, the three soil layers (blue) and the two groundwater zones (green).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># load some end state maps (initial conditions for the run)</span>
<span class="n">init_cond</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uncalibrated&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;calibrated&#39;</span><span class="p">:</span> <span class="p">{}}</span>
<span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tha&#39;</span><span class="p">,</span> <span class="s1">&#39;thb&#39;</span><span class="p">,</span> <span class="s1">&#39;thc&#39;</span><span class="p">,</span> <span class="s1">&#39;uz&#39;</span><span class="p">,</span> <span class="s1">&#39;lz&#39;</span><span class="p">]:</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_model</span><span class="si">}</span><span class="s1">initial/</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">_end.nc&#39;</span><span class="p">)</span>
    <span class="n">da</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">init_cond</span><span class="p">[</span><span class="s1">&#39;uncalibrated&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">da</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_model</span><span class="si">}</span><span class="s1">initial/calibrated/</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">_end.nc&#39;</span><span class="p">)</span>
    <span class="n">da</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">init_cond</span><span class="p">[</span><span class="s1">&#39;calibrated&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">da</span>

<span class="c1"># plot end state maps</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
<span class="n">plot_config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;soil&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;vars&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;tha&#39;</span><span class="p">,</span> <span class="s1">&#39;thb&#39;</span><span class="p">,</span> <span class="s1">&#39;thc&#39;</span><span class="p">],</span> <span class="s1">&#39;cmap&#39;</span><span class="p">:</span> <span class="s1">&#39;Blues&#39;</span><span class="p">},</span>
               <span class="s1">&#39;groudwater&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;vars&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;uz&#39;</span><span class="p">,</span> <span class="s1">&#39;lz&#39;</span><span class="p">],</span> <span class="s1">&#39;cmap&#39;</span><span class="p">:</span> <span class="s1">&#39;Greens&#39;</span><span class="p">}}</span>
<span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_config</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">]):</span>
        <span class="c1"># calculate minimum and maximum values for the colorbar</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">init_cond</span><span class="p">[</span><span class="n">sim</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="k">for</span> <span class="n">sim</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;uncalibrated&#39;</span><span class="p">,</span> <span class="s1">&#39;calibrated&#39;</span><span class="p">]])</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">init_cond</span><span class="p">[</span><span class="n">sim</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">sim</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;uncalibrated&#39;</span><span class="p">,</span> <span class="s1">&#39;calibrated&#39;</span><span class="p">]])</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;uncalibrated&#39;</span><span class="p">,</span> <span class="s1">&#39;calibrated&#39;</span><span class="p">]):</span>
            <span class="c1"># plot the map</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s</span>
            <span class="n">init_cond</span><span class="p">[</span><span class="n">sim</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;cmap&#39;</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="c1"># add title to each row</span>
            <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">.08</span><span class="p">,</span> <span class="mf">.8</span> <span class="o">-</span> <span class="mf">.2</span> <span class="o">*</span> <span class="n">row</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p><img alt="png" src="_images/4_2.png" /></p>
<p><em><strong>Figure 2</strong>. Initial conditions in the soil (blue) and groundwater (green) layers. In each of the groups of variables, the top row corresponds to the initial conditions with default parameters, and the bottom row to the initial conditions with calibrated parameters.</em></p>
<p>In our study case, the initial conditions of the soil layers have not changed significantly, but those of the groundwater zone are clearly different.</p>
</section>
<section id="lower-groundwater-zone">
<h3>3.2 Lower groundwater zone<a class="headerlink" href="#lower-groundwater-zone" title="Permalink to this headline">#</a></h3>
<p>In the previous figure we saw that the state of the lower groundwater zone is very different with the new calibrated warmup run. Since we have created the map stack for this variable, we can dig deeper in the differences between this warmup run with calibrated parameters and the the previous warmup run with default parameters.</p>
<p>The following figure shows the timeseries of the average lower groundwater storage (catchment mean) in both warmup runs.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># load map stack for the uncalibrated warmup</span>
<span class="n">lz</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_model</span><span class="si">}</span><span class="s1">out/warmup/lz.nc&#39;</span><span class="p">)</span>
<span class="n">lz</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># load map stack for the calibrated warmup</span>
<span class="n">lz_cal</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_model</span><span class="si">}</span><span class="s1">out/warmup/calibrated/lz.nc&#39;</span><span class="p">)</span>
<span class="n">lz_cal</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># plot comparison</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">lz</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;uncalibrated&#39;</span><span class="p">)</span>
<span class="n">lz_cal</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;calibrated&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;1979-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;1990-01-01&#39;</span><span class="p">),</span>
       <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
       <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
       <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;lower groundwater [mm]&#39;</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">[</span><span class="mf">0.45</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">.1</span><span class="p">,</span> <span class="mf">.1</span><span class="p">]);</span>
</pre></div>
</div>
<p><img alt="png" src="_images/4_3.png" /></p>
<p><em><strong>Figure 3</strong>. Evolution of the amount of water stored in the lower groundwater zone during the warmup run.</em></p>
</section>
</section>
<section id="run">
<h2>4 Run<a class="headerlink" href="#run" title="Permalink to this headline">#</a></h2>
<p>The previous figures were meant only to explain why the initialization and warmup simulations need to be rerun with the new calibrated parameters. If we didn’t, neither the initialization maps nor the initial conditions would correspond to the behaviour of the calibrated model, which would cause a strange model output at the beginning of the target run.</p>
<p>Now we are in a position to run our target simulation with a correct initialization and a calibrated model. The following figure compares the discharge simulated at the catchment outlet by both the uncalibrated and the calibrated models.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># settings files for the main run with default or calibrated parameters</span>
<span class="n">settings</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_model</span><span class="si">}</span><span class="s1">settings_run.xml&#39;</span>
<span class="n">settings_cal</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_model</span><span class="si">}</span><span class="s1">settings_calibrated_run.xml&#39;</span>

<span class="c1"># import non-calibrated discharge timeseries</span>
<span class="n">dis</span> <span class="o">=</span> <span class="n">read_tss</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_out</span><span class="si">}</span><span class="s1">disWin.tss&#39;</span><span class="p">,</span> <span class="n">xml</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>

<span class="c1"># import calibrated discharge timeseries</span>
<span class="n">dis_cal</span> <span class="o">=</span> <span class="n">read_tss</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path_out</span><span class="si">}</span><span class="s1">/calibrated/disWin.tss&#39;</span><span class="p">,</span> <span class="n">xml</span><span class="o">=</span><span class="n">settings_cal</span><span class="p">)</span>

<span class="c1"># plot timeseries</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dis</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;uncalibrated&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dis_cal</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;calibrated&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;2010-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2015-01-01&#39;</span><span class="p">),</span>
       <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="mi">4200</span><span class="p">),</span>
       <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;discharge [m3/s]&#39;</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">[</span><span class="mf">0.45</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">.1</span><span class="p">,</span> <span class="mf">.1</span><span class="p">]);</span>
</pre></div>
</div>
<p><img alt="png" src="_images/4_4.png" /></p>
<p><em><strong>Figure 4</strong>. River discharge at the catchment outlet with default (blue) or calibrated (orange) parameters.</em></p>
<p>As we see, the results differ when we run the calibrated model. These differences may seem small in our case study, but it is extremely important to calibrate the model before extracting any conclusions from the model results.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="3_run.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Main run</p>
        </div>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Joint Research Center - European Commission<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>